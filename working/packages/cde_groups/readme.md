# Package for СDE workflow

## Working with a local table
1. Create a manual table for groups (in your dev-schema)
    ```SQL
    DROP TABLE IF EXISTS cde_manual_group;
    CREATE TABLE cde_manual_group (
    	source_code TEXT NOT NULL,
    	source_code_description TEXT,
    	source_vocabulary_id TEXT NOT NULL,
    	group_id INT4 GENERATED BY DEFAULT AS IDENTITY (SEQUENCE NAME seq_cde_manual_group),
    	group_name TEXT NOT NULL,
    	target_concept_id INT4
    );
    CREATE UNIQUE INDEX idx_pk_cde_manual_group ON cde_manual_group ((source_code || ':' || source_vocabulary_id));
    CREATE INDEX idx_cde_manual_group_gid ON cde_manual_group (group_id);
    ```
2. Fill table with data, run ANALYZE cde_manual_group;

## Available operations
### Split the group into separate concepts
Input – group id  
Result – every group member should get their own group_id, group_name, group_code, where the group contains only one concept itself

Example:
```SQL
SELECT cde_groups.SplitGroup('cde_manual_group', 2 /*group id*/);
```

### Detach one or several concept from the group
Input – source_code:source_vocabulary_id (array)  
Result – every group member, indicated through source_code:source_vocabulary_id should be separated from the group and get their own group_id, group_name, group_code, where the group contains only one concept itself

Example:
```SQL
SELECT cde_groups.DetachConceptFromGroup('cde_manual_group', ARRAY['A18.002:ICD10CN',...] /*array of concepts*/);
```

### Merge groups
Input – group_id, source_code:source_vocabulary_id (array)  
Result – The group with the indicated group_id is merged with groups, which members are indicated through source_code:source_vocabulary_id pair

Example:
```SQL
SELECT cde_groups.MergeGroupsByConcept('cde_manual_group', 2 /*group id*/, ARRAY['A18.002:ICD10CN','B90.200:ICD10CN',...] /*array of concepts*/);
```

### Merge groups, case 2
Input – group_id1, group_id2, group_id3, etc  
Result – The group with the indicated group_id is merged with other group(s) indicated through group_id

Example:
```SQL
SELECT cde_groups.MergeGroupsByGroupID('cde_manual_group', 1, 2, 3, ... /*group ids separated by comma*/);
```

### Merge separate concepts in the group
Input – source_code:source_vocabulary_id (array)  
Result – indicated concepts should be united in a group

Example:
```SQL
SELECT cde_groups.MergeSeparateConcepts('cde_manual_group', ARRAY['A18.002:ICD10CN','B90.200:ICD10CN',...] /*array of concepts*/);
```

## Working with a Google spreadsheet
1. Create a Google spreadsheet with the same fields as in the manual table
2. Share your spreadsheet with our google service account

## Available operations
### Mapping harmonization
Group_id is used for mapping. All group members should then acquire the same target_concept_id in the CDE table with mappings on the server

Example:
```SQL
SELECT cde_groups.GSheetMappingHarmonization('cde_manual_group', '1a3os1cjgI...' /*spreadsheet id*/, 'Test_set_concepts' /*list name*/);
```

### Merge groups
In a group_code field a new source_code:vocabulary_id pair is placed as an indicator of a group that should be added to the existing one

Example:
```SQL
SELECT cde_groups.GSheetMergeGroups('cde_manual_group', '1a3os1cjgI...' /*spreadsheet id*/, 'Test_set_concepts' /*list name*/);
```

### Split the group case, regroup concepts

1. Split the group case  
In case when it is necessary to split the group, group_ids are deleted for every source_code, that should be detached from the group. Group_code, group_name remain unchanged

2. Regroup concepts within one group case 1  
When it is necessary to detach concepts from the group and unite them into another group, group_id is changed to negative numbers for concepts that should be detached and for another group, group_id is deleted for concepts, that should be only detached

3. Regroup concepts within one group case 2  
When it is necessary to detach concepts from the group and unite them into several groups or we are working with several groups simultaneously, new group_ids are assigned using negative numbers, group_id is deleted for concepts, that should be only detached

4. Detach concepts and add them into the group not represented in the spreadsheet  
When a concept or concepts should be detached from the group and added to another, that not represented in the spreadsheet, for such concept(s) group_id is deleted and in a group_code field a new source_code:vocabulary_id pair is placed as an indicator of a target group

Example:
```SQL
SELECT cde_groups.GSheetReGroup('cde_manual_group', '1a3os1cjgI...' /*spreadsheet id*/, 'Test_set_concepts' /*list name*/);
```

NOTE: for more info please read [documentation](https://docs.google.com/document/d/1tjkAvIlVXwSw_H83hV7F4hXw6YuVXng7fkwit7Yfaoo)