drop table drugs;
create table drugs as
select distinct fo_prd_id,a.PRD_NAME,a.MAST_PRD_NAME,a.DOSAGE,a.UNIT,a.DOSAGE2,a.UNIT2,a.MOL_EID,a.MOL_NAME,b.MOL_NAME as MOL_NAME_2, ATCCODE,ATC_NAME,NFC_CODE,MANUFACTURER
from fo_product_3 a join drug_mapping_3  b on a.prd_eid=b.prd_eid;

drop table drugs_3;
create table drugs_3 as 
select a.fo_prd_id, a.prd_name,a.mast_prd_name, DOSAGE_AS_TEXT as dosage, b.unit, DOSAGE2_AS_TEXT as dosage2, unit_id2 as unit2, a.mol_eid,a.mol_name, b.manufacturer,b.nfc_code,a.atccode, atc_name
from fo_product_3 a  left join drug_mapping_3 b on
a.prd_eid= b.prd_eid
;

UPDATE  DRUGS
SET MANUFACTURER = (SELECT MANUFACTURER FROM DRUGS_3 WHERE DRUGS_3.FO_PRD_ID = DRUGS.FO_PRD_ID)
;
UPDATE  DRUGS
SET ATCCODE = (SELECT ATCCODE FROM DRUGS_3 WHERE DRUGS_3.FO_PRD_ID = DRUGS.FO_PRD_ID AND DRUGS_3.ATCCODE NOT IN ('%IMIQUIMOD%','-1','??'))
;
INSERT INTO DRUGS (FO_PRD_ID,PRD_NAME,MAST_PRD_NAME,DOSAGE,UNIT,DOSAGE2,UNIT2,MOL_EID,MOL_NAME,ATCCODE,ATC_NAME,NFC_CODE,MANUFACTURER)
select  FO_PRD_ID, PRD_NAME,MAST_PRD_NAME,DOSAGE,UNIT,DOSAGE2,UNIT2,MOL_EID,MOL_NAME,ATCCODE,ATC_NAME,nfc_code,MANUFACTURER 
from drugs_3 where fo_prd_id not in (select fo_prd_id from drugs)
;

--next manipulation requires correct numbers--
update drugs 
set PRD_NAME=regexp_replace(PRD_NAME,',','.') where PRD_NAME is not null;
update drugs
SET PRD_NAME=REGEXP_REPLACE(PRD_NAME,'"')
;



drop table non_drug;
create table non_drug as (select  distinct * from drugs where ATCCODE in('V01AA07','V03AK','V04B','V04CL','V04CX','V20','D02A','D02AD','D09A','D02AX','D02BA','D02AC')
or ATCCODE like 'V06%' or ATCCODE like 'V07%');

insert into non_drug
select * from drugs where regexp_like (PRD_NAME,'STOCKING|STRIPS|REMOVER|KCAL|NUTRISION|BREATH-ALERT|CHAMBER|REMOVAL|GAUZE|SUPPLY|PROTECTORS|SOUP|DRESSING|CLEANSER|BANDAGE|BEVERAGE|RESOURCE|WEIGHT|[^IN]TEST[^O]')
and fo_prd_id not in (select fo_prd_id from non_drug);

insert into non_drug  
select * from drugs where (MAST_PRD_NAME like '%SUN%' or   MAST_PRD_NAME like '%ACCU-CHEK%' or MAST_PRD_NAME like '%ACCUTREND%')  and  MAST_PRD_NAME not like '%SELSUN%'
and fo_prd_id not in (select fo_prd_id from non_drug);

insert into non_drug
select * from drugs where regexp_like(mol_name, 'IUD|LEUCOCYTES|AMIDOTRIZOATE|BANDAGE');

insert into non_drug
select * from drugs where regexp_like(nfc_code,'VZT|VGB|VGA|VZY|VEA|VED|VEK|VZV') and fo_prd_id not in (select fo_prd_id from non_drug);

ALTER TABLE non_drug
 RENAME COLUMN fo_prd_id to concept_code;
 








