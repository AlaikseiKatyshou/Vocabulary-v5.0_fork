--make a proper dose form from the short terms used in a concept_names
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'oin$','ointment' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'tab$','tablet' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'inj$','injection' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'cre$','cream' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'lin$','linctus' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'sol$','solution' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'cap$','capsule' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'loz$','lozenge' )
;
update gemscr_3 set --then in final script need to combine these two in one query
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'lozenge$','lozenges' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'sus$','suspension' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'eli$','oral tablet' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'sup$','suppositories' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'gra$','granules' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'pow$','powder' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'pel$','pellets' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'lot$','lotion' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'syr$','syringe' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'app$','applicator' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'dro$','drops' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'aer$','aerosol' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'liq$','liquid' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'homeopathic pillules$','pills' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'spa$','spansules' )
;
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'emu$','emulsion' )
;
--paste
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'pas$','paste' )
;
--pillules
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'pillules$','pills' )
;
--spray
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'spr$','spray' )
;
--inhalation
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'inh$','inhalation' )
;
--suppositories
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'suppository$','suppositories' )
;
--oitnment
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'oitnment$','ointment' )
;
--pessary
update gemscr_3 set 
GENERIC_NAME = regexp_replace (GENERIC_NAME, 'pes$','pessary' )
;

--dosage and form taken from drug description 
drop table gemscr_3;
create table gemscr_3 as (
select regexp_substr (pos_dosage, '.*\d *(mg|%|ml|mcg|hr|hours|unit|units|iu|g|microgram(s*)|u|mmol|c|gm)(/g|/dose|/ml|/mg|/ampoule)*') as dosage , 
regexp_replace (pos_dosage, '.*\d *(mg|%|ml|mcg|hr|hours|unit|units|iu|g|microgram(s*)|u|mmol|c|gm)(/g|/dose|/ml|/mg|/ampoule)* *') as form,
DRUG_COMP, FORMULATION, GEMSCRIPT_CODE, GENERIC_NAME, POS_DOSAGE, POS_INGR, STRENGTH, UNITS  from gemscr_2
)
;

--some ds_stage work, not sure if it's helpful
drop TABLE DRUG_STRENGTH_STAGE;
CREATE TABLE DRUG_STRENGTH_STAGE
(
drug_concept_code		varchar(255)	,
ingredient_concept_code		varchar(255)	,
amount_value		float	,
amount_unit		varchar(255)	,
numerator_value		float	,
numerator_unit		varchar(255)	,
denominator_value		float	,
denominator_unit		varchar(255)	,
box_size	integer
)
;
--easiest part, when there is 1 ingredient and dosage and unit information provided is not null
;
insert into drug_strength_stage (DRUG_CONCEPT_CODE,INGREDIENT_CONCEPT_CODE,AMOUNT_VALUE,AMOUNT_UNIT,NUMERATOR_VALUE,NUMERATOR_UNIT,DENOMINATOR_VALUE,DENOMINATOR_UNIT,BOX_SIZE)
select distinct a.concept_code_1, a.concept_code_2, 
case when UNITS  not like '%\%%' escape  '\' and UNITS  not in (select units from gemscr_10 where regexp_like (units, '.*/.*(mL|ml|hour(s)*|g|hrs)' )) then regexp_substr (STRENGTH,'[[:digit:]\.]+')  else null end as AMOUNT_VALUE,
case when UNITS  not like '%\%%' escape  '\' and UNITS  not in (select units from gemscr_10 where regexp_like (units, '.*/.*(mL|ml|hour(s)*|g|hrs)' )) then regexp_substr (units, '(mg|ml|mcg|unit|units|iu|g|u|mmol|c|gm)') else null end as AMOUNT_unit,
case when UNITS  like '%\%%' escape  '\' or  regexp_like (units, '.*/.*(mL|ml|hour(s)*|g|hrs)' ) then regexp_substr (STRENGTH,'[[:digit:]\.]+') else null end as NUMERATOR_VALUE,
case when UNITS  like '%\%%' escape  '\' or  regexp_like (units, '.*/.*(mL|ml|hour(s)*|g|hrs)') then  regexp_substr (units, '(mg|ml|mcg|unit|units|iu|g|u|mmol|c|gm|%)' )else null end as NUMERATOR_unit,
case when regexp_like (units, '.*/[[:digit:]\.]+.*') then  regexp_substr (UNITS, '[[:digit:]\.]+') else null end as DENOMINATOR_VALUE,
case when regexp_like (units, '.*/.*+') then regexp_substr (units, '(mL|ml|hour(s)*|g|hrs)$') else null end as DENOMINATOR_UNIT,
'' as BOX_SIZE
from  internal_relationship_stage a join drug_concept_stage b on a.concept_code_1 = b.concept_code and b.concept_class_iD like '%Drug%'
join drug_concept_stage c on a.concept_code_2 = c.concept_code and c.concept_class_id = 'Ingredient'
join gemscr_10 d on d.gemscript_code = a.concept_code_1 
where STRENGTH not like '%+%' and units not like '%+%'
;
create table drug_strength_step1 as (select * from drug_strength_stage)
; 
-- there are 1 or several ingredients, take dosage from "dosage" column
insert into drug_strength_stage (DRUG_CONCEPT_CODE,INGREDIENT_CONCEPT_CODE,AMOUNT_VALUE,AMOUNT_UNIT,NUMERATOR_VALUE,NUMERATOR_UNIT,DENOMINATOR_VALUE,DENOMINATOR_UNIT,BOX_SIZE)
select distinct a.concept_code_1, a.concept_code_2, 
case when dosage  not like '%\%%' escape  '\' and dosage  not in (select dosage from gemscr_10 where regexp_like (units, '.*/.*(mL|ml|hour(s)*|g|hrs)' )) then regexp_substr (dosage,'^[[:digit:]\.]+')  else null end as AMOUNT_VALUE,
case when dosage  not like '%\%%' escape  '\' and dosage  not in (select units from gemscr_10 where regexp_like (units, '.*/.*(mL|ml|hour(s)*|g|hrs)' )) then regexp_substr (units, '^(mg|ml|mcg|unit|units|iu|g|u|mmol|c|gm)') else null end as AMOUNT_unit,
case when dosage  like '%\%%' escape  '\' or  regexp_like (dosage, '.*/.*(mL|ml|hour(s)*|g|hrs)' ) then regexp_substr (STRENGTH,'^[[:digit:]\.]+') else null end as NUMERATOR_VALUE,
case when dosage  like '%\%%' escape  '\' or  regexp_like (dosage, '.*/.*(mL|ml|hour(s)*|g|hrs)') then  regexp_substr (dosage, '^(mg|ml|mcg|unit|units|iu|g|u|mmol|c|gm|%)' )else null end as NUMERATOR_unit,
case when regexp_like (dosage, '.*/[[:digit:]\.]+.*') then  regexp_substr (dosage, '[[:digit:]\.]+$') --need to change because now it doesn't include last digits properly
 else null end as DENOMINATOR_VALUE,
case when regexp_like (dosage, '.*/.*+') then regexp_substr (dosage, '(mL|ml|hour(s)*|g|hrs)$') else null end as DENOMINATOR_UNIT,
'' as BOX_SIZE
from  internal_relationship_stage a join drug_concept_stage b on a.concept_code_1 = b.concept_code and b.concept_class_iD like '%Drug%'
join drug_concept_stage c on a.concept_code_2 = c.concept_code and c.concept_class_id = 'Ingredient'
join gemscr_10 d on d.gemscript_code = a.concept_code_1 
where gemscript_code not in (select drug_concept_code from drug_strength_step1)
and dosage not like '%+%' and dosage not like '%with%'
;
select distinct regexp_replace (UNITS, '.*/\d*\.*\d*') , units from gemscr_10
;
select distinct regexp_substr (UNITS, '[[:digit:]\.]+') , units from gemscr_10
;
select distinct regexp_substr (units, '(mL|ml|hour(s)*|g|hrs)$'), units from gemscr_10
;
--replace micrograms
update gemscr_10 set UNITS = replace (UNITS, 'micrograms', 'mcg')
;
update gemscr_10 set UNITS = replace (UNITS, 'microgram', 'mcg')
;
update gemscr_10 set dosage = replace (dosage, 'micrograms', 'mcg')
;
update gemscr_10 set dosage = replace (dosage, 'microgram', 'mcg')
;
--part of weird regexp with all the forms I found, not sure it's useful now as we already have dm+d Dose Forms well defined and mapped
'CFC-free inhaler|Capsules|IV dressings|Rectube|adhesive plaster|alcoholic lotion|ampoules|applicator|bandage|bath emulsion|bath oil|bath solution|buccal tablets|caplets|capsules|chesty cough linctus|chewable tablets|chewing gum|collodion BP
|colourless cream|cream|crystals|dental lacquer|diabetic linctus|disks plus disk inhaler|disks refill|dispersible tablets|douche plus fittings|dropper|dry powder spray|dusting powder|ear drops|ear spray|effervescent granules|effervescent tablets|
emollient cream|eye drops|eye irrigation solution|eye/ear ointment|film|foam|gastro-resistant capsules|gastro-resistant tablets|gauze|gauze swabs|gel kit|gel plus dressing|gel-forming eye drops|granules|granules for suspension|implant|infant suppositories|
infusion (powder for reconstitution)|infusion plus diluent|inhalation|inhalation capsules|inhalator|inhaler|inhaler plus spacer|inhaler refill|inhaler solution|injection|injection (powder|injection (powder for reconstitution)|injection cartridge|
injection plus diluent|injection refills|injection solution|injection vial|insufflator|intra articular/ intradermal injection|intra articular/intramuscular injection|intra-muscular injection|intramuscular injection (pdr for recon)|intranasal solution|
intrathecal injection|intravenous infusion|intravenous infusion concentrate|intravenous infusion plus buffer|intravenous solution|irrigation solution|junior capsules|junior lozenges|linctus|lip protector|lipocream|liquid|lotio-gel|lozenges|maintenance set|
matrigel capsules|melt tablets|milk|modified release granules|modified release tablets|mouthwash and gargle|multi-dose vial|nail lacquer|nasal gel|nasal ointment|nebuliser solution|nose drops|nose gel|ocular insert|oil|oily cream|oily injection|ointment|
ointment & suppositories|ophthalmic solution|oral drops|oral emulsion|oral liquid|oral paint|oral powder|oral syringe|oro-dispersible film|pack|pad|paediatric capsules|paediatric drops|paediatric mixture|paediatric solution|paediatric sugar free suspension|
paediatric suspension|paediatric syrup|paint|paper|patches|pellets|periodontal gel|pessary plus cream|plaster|poultice|powder|powder for reconstitution|prefilled pen|rectal foam|rectal solution|retention enema|sachet|sachets|scalp and skin cleanser solution|
scalp application|scalp lotion|scalp solution|semi-solid|single dose injection vial|single dose unit eye drops|single dose unit eye gel|skin cleanser solution|soluble tablets|spincaps|spirit|spray|spray application|spray solution|starter pack|sterile solution|
sterile suspension|sterile swabs|stocking|subcutaneous injection|sublingual tablets|sugar free chewable tablets|sugar free dispersible tablets|sugar free granules|sugar free linctus|sugar free lozenges|sugar free mixture|sugar free paediatric linctus|sugar free paediatric syrup|sugar free suspension|suppositories|surgical scrub|swabs|tablet|tablet pack|tablets & pessaries|tablets plus granules|tampons|throat spray|toothpaste|topical gel|topical liquid|tube|unit dose blisters|unit dose vial|vaccine|vaginal capsules|vaginal cleansing kit|vaginal cream|vaginal ring|vials|vitrellae|volatile liquid|vortex metered dose inhaler|wax|wax stick
;
